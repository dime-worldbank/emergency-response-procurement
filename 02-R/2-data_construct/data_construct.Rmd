---
title: "Data Construct"
author: "Victor Gamarra"
date: "7/27/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup packages

```{r setup, include=FALSE}
packages <-
	c(
		"ggplot2",
		"tidyverse",
		"data.table",
		"dplyr",
		"readxl",
		"haven",
		"here",
		"rgdal",
		"writexl",
		"lubridate",
		"skimr"
		)
  

pacman::p_load(packages,
               character.only = TRUE, # So we can list all packages in a single vector
               dependencies = TRUE)   # Install packages that are required by the packages we listed

```


## Loading raw data

```{r}

awards.final <- readRDS("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/1-raw/awards_data.Rda")

bids.final <- readRDS("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/1-raw/bids_data.Rda")

complaints.final <- readRDS("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/1-raw/complaints_data.Rda")

initiation.final <- readRDS("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/1-raw/initiation_data.Rda")

```


## Creating indicators of Task 1


# Indicator: Number of bidders per tender

Number of bidders is defined as the number of firms who bid within an award and lot. Missing values at the firm identifier (bidder_cui) are excluded from the count.

```{r}

table(bids.final$bid_accepted)

bids.final.complete <- bids.final %>% 
  filter(bidder_cui!="NA")

bids.final.complete <- bids.final.complete %>% 
  group_by(award_notice_id, lot_number) %>% 
  mutate(bidders = n())

hist(bids.final.complete$bidders)


```

# Indicator: New winners and New Bidders

A *new winner* is defined if the firm has no existing contract or an existing contract older than 12 months. 

```{r}


awards.final <- awards.final %>% 
  group_by(winner_cui_id) %>% 
  arrange(winner_cui_id,contract_date) %>% 
  mutate(diff_days_contract = difftime(contract_date, lag(contract_date) , units = "days"),
         new_winner = case_when(is.na(diff_days_contract) ~ 1 ,
                                diff_days_contract > 365 ~ 1 ,
                                TRUE ~ 0 ))
         


# old indicators


awards.final <- awards.final %>% 
  group_by(winner_cui_id, month_yr) %>% 
  mutate(timeswinner = row_number(),
         new_winner = ifelse(timeswinner == 1 , 1 ,0)) %>% 
  ungroup()

awards.final <- awards.final %>% 
  group_by(winner_cui_id, month_yr) %>% 
  mutate(timeswinner = row_number(),
         new_winner = ifelse(timeswinner == 1 , 1 ,0)) %>% 
  ungroup()
  
awards.final <- awards.final %>% 
  group_by(winner_cui_id, new_winner) %>% 
  mutate(year_month_first_win = month_yr)

awards.final <- awards.final %>% 
  mutate(month_yr_contract = format_ISO8601(contract_date, precision = "ym"),
         month_yr_init = format_ISO8601(initiation_notice_date, precision = "ym"),
         diff_days_init_contract = difftime(contract_date,initiation_notice_date , units = "days"))

 

```

# Indicator: Market concentration 


```{r}

sector.total <- awards.final %>% 
  group_by(
    cpv_div_name, contract_year) %>% 
  summarise(
    total_sector=sum(value_ron, na.rm = TRUE))

awards.final <- left_join(
  awards.final, sector.total, by = c('cpv_div_name' = 'cpv_div_name' , 'contract_year' = 'contract_year')) 

awards.final <- awards.final %>% 
  mutate(firm_share = value_ron / total_sector)

hist(awards.final$firm_share)



```


