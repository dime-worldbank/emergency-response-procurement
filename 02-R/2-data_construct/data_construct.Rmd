---
title: "Data Construct"
author: "Victor Gamarra"
date: "7/27/2022"
output: pdf_document
---


```{r}

# 1) Set working directory
if (Sys.info()['user'] == "Victo" ) {   
  setwd("/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/2-data_construct")
} else {  
 setwd("C:/Users/wb554125/Documents/GitHub/ie-dr-endline/IE_DR_endline/1. Data cleaning")
}
#Maria enter path to data here}

```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup packages

```{r setup, include=FALSE}
packages <-
	c(
		"ggplot2",
		"tidyverse",
		"data.table",
		"dplyr",
		"readxl",
		"haven",
		"here",
		"rgdal",
		"writexl",
		"lubridate",
		"skimr",
		"googleLanguageR",
		"cld2",
		"writexl",
		"zoo"
		)
  

pacman::p_load(packages,
               character.only = TRUE, # So we can list all packages in a single vector
               dependencies = TRUE)   # Install packages that are required by the packages we listed

```

# Loading raw data

```{r}

awards.final <- readRDS("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/1-raw/awards_data.Rda")

bids.final <- readRDS("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/1-raw/bids_data.Rda")

complaints.final <- readRDS("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/1-raw/complaints_data.Rda")

initiation.final <- readRDS("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/1-raw/initiation_data.Rda")

```

# Creating indicators of Task 1


## Indicator: Number of bidders per tender

Number of bidders is defined as the number of firms who bid within an award and lot. Missing values at the firm identifier (bidder_cui) are excluded from the count.

```{r}

table(bids.final$bid_accepted)

# deleting missing values
bids.final.complete <- bids.final %>% 
  filter(bidder_cui!="NA")

# calculating number of bidders
bids.final.complete <- bids.final.complete %>% 
  group_by(award_notice_id, lot_number) %>% 
  mutate(bidders = n(),
         bid_accepted_n = if_else(bid_accepted==TRUE,1,0))

# obtaining initiation date
dates.initiation <- initiation.final %>% 
  select(initiation_notice_id , initiation_notice_date)

bids.final.complete <- left_join(bids.final.complete , dates.initiation , by  = 'initiation_notice_id')

# creating monthly bidders and plots
bids.final.complete <- bids.final.complete %>% 
  mutate(month_yr_init = format_ISO8601(initiation_notice_date, precision = "ym"))

bids.final.month <- bids.final.complete %>% 
  group_by(month_yr_init) %>% 
  summarise(N_bidders_month = sum(bidders),
            percent_accepted = mean(bid_accepted_n, na.rm = TRUE))

bids.final.month <- bids.final.month %>% 
  mutate(date = as.Date.character(paste(month_yr_init,"-01",sep="")))
      
ggplot(bids.final.month, aes(x=date, y=N_bidders_month)) +
  geom_line() + 
  xlab("")

ggplot(bids.final.month, aes(x=date, y=percent_accepted)) +
  geom_line() + 
  xlab("")

```

# Indicator: New winners and New Bidders

A *new winner* is defined as a winner (awarded) if the firm has no existing contract or an existing contract older than 12 months. 

A *new bidder* is defined as a bidder that has no bids or an existing bid older than 12 months

month and year dates are created according to Serena's recommendation, but at the end I used the day, month and year dates to calculate the days between contracts instead of the months. 

```{r}

# creating months-year variables
awards.final <- awards.final %>% 
  mutate(month_yr_contract = format_ISO8601(contract_date, precision = "ym"),
         month_yr_init = format_ISO8601(initiation_notice_date, precision = "ym"),
         diff_days_init_contract = difftime(contract_date,initiation_notice_date , units = "days"))

# New Winners
awards.final <- awards.final %>% 
  group_by(winner_cui_id) %>% 
  arrange(winner_cui_id,contract_date) %>% 
  mutate(diff_days_contract = difftime(contract_date, lag(contract_date) , units = "days"),
         new_winner = case_when(is.na(diff_days_contract) ~ 1 ,
                                diff_days_contract > 365 ~ 1 ,
                                TRUE ~ 0 ))

# New Bidders
bids.final.complete <- bids.final.complete %>% 
  group_by(bidder_cui) %>%
  arrange(bidder_cui,initiation_notice_date) %>%
  mutate(diff_days_initiation = difftime(initiation_notice_date, lag(initiation_notice_date) , units = "days"),
         new_bidder = case_when(is.na(diff_days_initiation) ~ 1 ,
                                diff_days_initiation > 365 ~ 1 ,
                                TRUE ~ 0 ))

# Plots
ggplot(awards.final, aes(x=contract_date, y=new_winner)) +
  geom_line() + 
  xlab("")

ggplot(bids.final.complete, aes(x=initiation_notice_date, y=new_bidder)) +
  geom_line() + 
  xlab("")

```

# Indicator: Market concentration 

```{r}

sector.total <- awards.final %>% 
  group_by(
    cpv_div_name, contract_year) %>% 
  summarise(
    total_sector=sum(value_ron, na.rm = TRUE))

awards.final <- left_join(
  awards.final, sector.total, by = c('cpv_div_name' = 'cpv_div_name' , 'contract_year' = 'contract_year')) 

awards.final <- awards.final %>% 
  mutate(firm_share = value_ron / total_sector)

hist(awards.final$firm_share)

```

# Product classification

```{r}

CPV.data <- initiation.final %>% 
  arrange(cpv_div_name,cpv_group_name) %>%
  select(cpv_div_name, cpv_group_name, cpv_group, cpv_div) %>% 
  distinct()

write.csv(CPV.data,"C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/2-clean/Data_CPV_Romania.csv", row.names = FALSE)


```

# Variables for complaint data and translation

```{r}

# Obtaining exporting data andto translate in google translate
appeals <- complaints.final %>% 
  select(appeal_object, appeal_id) %>% 
  distinct()

procedures <- complaints.final %>% 
  select(procedure_name, appeal_id) %>% 
  distinct()

write_xlsx(appeals,"C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/2-clean/appeals.xlsx")

write_xlsx(procedures,"C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/2-clean/procedures.xlsx")


# translating variables that are translated in R
complaints.final <- complaints.final %>% 
  mutate(
    contested_en = case_when(
      contested == "Documentatie" ~ "Documentation", 
      contested == "Rezultat" ~ "Result"),
    outcome_en = case_when(
      outcome == "Admite" ~ "Admited",
      outcome == "Altele" ~ "Other",
      outcome == "Respinge" ~ "Rejected"),
    outcome_method_en = case_when(
      outcome_method == "Pe exceptii" ~ "On exceptions", 
      outcome_method == "Pe fond" ~ "Based on")
    )
    
# Importing translated Data
appeals.en <- read_excel("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/2-clean/appeals_en.xlsx")

procedures.en <- read_excel("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/2-clean/procedures_en.xlsx")

# Joining translated data
complaints.final <- left_join(complaints.final, appeals.en , by = 'appeal_id')
complaints.final <- left_join(complaints.final, procedures.en , by = 'appeal_id')


```



