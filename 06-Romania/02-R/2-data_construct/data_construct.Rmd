---
title: "Data Construct"
author: "Victor Gamarra"
date: "7/27/2022"
output: pdf_document
---


```{r}

# 1) Set working directory
if (Sys.info()['user'] == "Victo" ) {   
  setwd("/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/2-data_construct")
} else {  
 setwd("C:/Users/wb554125/Documents/GitHub/ie-dr-endline/IE_DR_endline/1. Data cleaning")
}
#Maria enter path to data here}

```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup packages

```{r setup, include=FALSE}
packages <-
	c(
		"ggplot2",
		"tidyverse",
		"data.table",
		"dplyr",
		"readxl",
		"haven",
		"here",
		"rgdal",
		"writexl",
		"lubridate",
		"skimr",
		"googleLanguageR",
		"cld2",
		"writexl",
		"zoo"
		)
  

pacman::p_load(packages,
               character.only = TRUE, # So we can list all packages in a single vector
               dependencies = TRUE)   # Install packages that are required by the packages we listed

```

# Loading raw data

```{r}

awards.final <- readRDS("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/1-raw/awards_data.Rda")

bids.final <- readRDS("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/1-raw/bids_data.Rda")

complaints.final <- readRDS("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/1-raw/complaints_data.Rda")

initiation.final <- readRDS("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/1-raw/initiation_data.Rda")

table(awards.final$award_year)
table(awards.final$contract_year)
table(awards.final$initiation_year)

table(bids.final$award_year)
table(bids.final$initiation_year)

```

# Creating indicators of Task 1


## Indicator: Number of bidders per tender

Number of bidders is defined as the number of firms who bid within an award and lot. Missing values at the firm identifier (bidder_cui) are excluded from the count. Data then is collapsed at the monthly level to produce a graph.

```{r}

table(bids.final$bid_accepted)

# deleting missing values
bids.final.complete <- bids.final %>% 
  filter(bidder_cui!="NA")

# calculating number of bidders
bids.final.complete <- bids.final.complete %>% 
  group_by(award_notice_id, lot_number) %>% 
  mutate(bidders = n(),
         bid_accepted_n = if_else(bid_accepted==TRUE,1,0))

# obtaining initiation date
dates.initiation <- initiation.final %>% 
  select(initiation_notice_id , initiation_notice_date)

bids.final.complete <- left_join(bids.final.complete , dates.initiation , by  = 'initiation_notice_id')

# creating monthly bidders and plots
bids.final.complete <- bids.final.complete %>% 
  mutate(month_yr_init = format_ISO8601(initiation_notice_date, precision = "ym"))

bids.monthly <- bids.final.complete %>% 
  group_by(month_yr_init) %>% 
  summarise(N_bidders_month = sum(bidders),
            percent_accepted = mean(bid_accepted_n, na.rm = TRUE)) %>% 
  mutate(date = as.Date.character(paste(month_yr_init,"-01",sep="")))

ggplot(bids.monthly, aes(x=date, y=N_bidders_month)) +
  geom_line() + 
  xlab("")
ggsave("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/3-analysis/Figures/number_bidders.png")

ggplot(bids.monthly, aes(x=date, y=percent_accepted)) +
  geom_line() + 
  xlab("")
ggsave("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/3-analysis/Figures/percent_bids_accepted.png")

```

# Indicator: New winners and New Bidders

A *new winner* is defined as a winner (awarded) if the firm has no existing contract or an existing contract older than 12 months. The contract date allows to calculate the number of days between contracts.

A *new bidder* is defined as a bidder that has no bids or an existing bid older than 12 months. The initiation date allows to calculate the number of days between contracts.

The data then is aggregated at the monthly level to produce graphical representations.

```{r}

# New Winners
awards.final <- awards.final %>% 
  mutate(month_yr_contract = format_ISO8601(contract_date, precision = "ym"),
         month_yr_init = format_ISO8601(initiation_notice_date, precision = "ym"),
         diff_days_init_contract = difftime(contract_date,initiation_notice_date , units = "days"))%>% 
  filter(month_yr_contract!="NA")

awards.final <- awards.final %>% 
  group_by(winner_cui_id) %>% 
  arrange(winner_cui_id,contract_date) %>% 
  mutate(diff_days_contract = difftime(contract_date, lag(contract_date) , units = "days"),
         new_winner = case_when(is.na(diff_days_contract) ~ 1 ,
                                diff_days_contract > 365 ~ 1 ,
                                TRUE ~ 0 )) 

awards.monthly <- awards.final %>% 
  group_by(month_yr_contract) %>% 
  summarise(new_winner_month = sum(new_winner)) %>% 
  mutate(date = as.Date.character(paste(month_yr_contract,"-01",sep=""))) 
 

# New Bidders
bids.final.complete <- bids.final.complete %>% 
  group_by(bidder_cui) %>%
  arrange(bidder_cui,initiation_notice_date) %>%
  mutate(diff_days_initiation = difftime(initiation_notice_date, lag(initiation_notice_date) , units = "days"),
         new_bidder = case_when(is.na(diff_days_initiation) ~ 1 ,
                                diff_days_initiation > 365 ~ 1 ,
                                TRUE ~ 0 ))

bids.monthly <- bids.final.complete %>% 
  group_by(month_yr_init) %>% 
  summarise(new_bidder_month = sum(new_bidder)) %>% 
  mutate(date = as.Date.character(paste(month_yr_init,"-01",sep=""))) 
 
# Plots
ggplot(awards.monthly, aes(x=date, y=new_winner_month)) +
  geom_line() + 
  xlab("")
ggsave("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/3-analysis/Figures/new_winners.png")

ggplot(bids.monthly, aes(x=date, y=new_bidder_month)) +
  geom_line() + 
  xlab("")
ggsave("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/3-analysis/Figures/new_bidders.png")

```

# Indicator: Market concentration 

Two measures of market concentration: number of bidders and winners per sector, and total value of firms' bids per sector

total value of the bids per sector.

The *total value of firms' bids per sector* is calculated by obtaining the total value from all contracts at the sector level (three digits of CPV code), and the total value of the firm's contract. These variables are calculated at the yearly level. Then, the market share of the firm is defined as the ratio between the total value of the firm's contract divided by the total value of the sector.

Then the data is aggregated at the monthly level to produce graphical representations. As some of the firms participate in more than one sector, there are extreme values. Those outliers are dropped in a second graph to allow a better visualization of the data.

```{r}

# number of bidders and winners per sector


# Total value of firms' bids per sector 
sector.total <- awards.final %>% 
  group_by(cpv_group_name, contract_year) %>% 
  summarise(total_sector=sum(value_ron, na.rm = TRUE))

firms.total <- awards.final %>% 
  group_by(winner_cui_id, contract_year) %>% 
  summarise(total_firm=sum(value_ron, na.rm = TRUE))

awards.final <- left_join(awards.final, sector.total, by = c('cpv_group_name','contract_year')) 
awards.final <- left_join(awards.final, firms.total, by = c('winner_cui_id','contract_year')) 

awards.final.firms <- awards.final %>% 
  mutate(firm_share = (total_firm / total_sector)*100) %>% 
  distinct(winner_cui_id, contract_year, .keep_all = TRUE) %>% 
  group_by(month_yr_contract, winner_cui_id) %>% 
  summarise(share_monthly = sum(total_firm)/sum(total_sector)) %>% 
  mutate(date = as.Date.character(paste(month_yr_contract,"-01",sep="")))

ggplot(awards.final.firms, aes(x = date, y = share_monthly)) + geom_point() + xlab("Month-year")
ggsave("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/3-analysis/Figures/Firms_share_monthly.png")

awards.final.firms.nooutliers <- awards.final.firms %>% 
  filter(share_monthly<100)

ggplot(awards.final.firms.nooutliers, aes(x = date, y = share_monthly)) + geom_point() + xlab("Month-year")
ggsave("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/3-analysis/Figures/Firms_share_monthly_noout.png")

```

# Product classification

(pending)

```{r}

CPV.data <- initiation.final %>% 
  arrange(cpv_div_name,cpv_group_name) %>%
  select(cpv_div_name, cpv_group_name, cpv_group, cpv_div) %>% 
  distinct()

write.csv(CPV.data,"C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/2-clean/Data_CPV_Romania.csv", row.names = FALSE)


```

# Variables for complaint data and translation

```{r}

# Obtaining exporting data andto translate in google translate
appeals <- complaints.final %>% 
  select(appeal_object, appeal_id) %>% 
  distinct()

procedures <- complaints.final %>% 
  select(procedure_name, appeal_id) %>% 
  distinct()

write_xlsx(appeals,"C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/2-clean/appeals.xlsx")

write_xlsx(procedures,"C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/2-clean/procedures.xlsx")


# translating variables that are translated in R
complaints.final <- complaints.final %>% 
  mutate(
    contested_en = case_when(
      contested == "Documentatie" ~ "Documentation", 
      contested == "Rezultat" ~ "Result"),
    outcome_en = case_when(
      outcome == "Admite" ~ "Admited",
      outcome == "Altele" ~ "Other",
      outcome == "Respinge" ~ "Rejected"),
    outcome_method_en = case_when(
      outcome_method == "Pe exceptii" ~ "On exceptions", 
      outcome_method == "Pe fond" ~ "Based on")
    )
    
# Importing translated Data
appeals.en <- read_excel("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/2-clean/appeals_en.xlsx")

procedures.en <- read_excel("C:/Users/Victo/Documents/GitHub/emergency-response-procurement/02-R/4-datasets/2-clean/procedures_en.xlsx")

# Joining translated data
complaints.final <- left_join(complaints.final, appeals.en , by = 'appeal_id')
complaints.final <- left_join(complaints.final, procedures.en , by = 'appeal_id')


```



